\RequirePackage[colorlinks]{hyperref}

%\newif\ifmmtfinal
%\DeclareOption{final}{\mmtfinaltrue}
%\DeclareOption{draft}{\mmtfinalfalse}
%\ProcessOptions

%% the MMT delimiters are 'invalid' by default, this makes them 'other'
% to write them, use ^^1c -- ^^1f
\catcode28=12
\catcode29=12
\catcode30=12
\catcode31=12

\newcounter{mmtobject}

\newcommand{\mmt@lmtname}{\jobname.lmt}

\IfFileExists{./\mmt@lmtname.sty}{\usepackage{\mmt@lmtname}}{}

% MMT file is written to \mmt@lmtname using the handle \lmtfile
\newwrite\lmtfile
\immediate\openout\lmtfile=\mmt@lmtname
%\immediate\write\lmtfile{theory \jobname\space =}
\AtEndDocument{
  \immediate\write\lmtfile{^^1d}
  \immediate\closeout\lmtfile
}

% \mmt@X is the name for the command of the X-th MMT object
\newcommand{\mmt@current}{mmt@\themmtobject}

% writes out an MMT object and executes \mmt@current
\newcommand{\fromMMT}[1]{
  \toMMT{constant \mmt@current\space = #1^^1e}
  \ifcsname\mmt@current\endcsname\else
  \errmessage{undefined MMT object #1 with id \themmtobject}
  \fi
  \csname\mmt@current\endcsname % creates command as alias for \relax if it does not exist
  \stepcounter{mmtobject}
}

\newcommand{\toMMT}[1]{\immediate\write\lmtfile{#1}}

% abbreviations of \toMMT for common situations --- not tested
\newcommand{\mmtheory}[2]{\toMMT{theory #1 : #2 =}}
\newcommand{\mmtheoryend}{\toMMT{^^1d}}
\newcommand{\mmtinclude}[1]{\toMMT{include #1 ^^1e}}
\newcommand{\mmtconstant}[4]{\toMMT{constant #1 \mmt@ifnonempty{#2}{:#2^^1f} \mmt@ifnonempty{#3}{= #3^^1f} \mmt@ifnonempty{#4}{\# #4^^1f} ^^1e}}

%% !TERM! is an alias for \fromMMT{TERM}, thus yielding notation similar to Latex $TERM$
\catcode`!=13
\def!#1!{\ensuremath{\fromMMT{#1}}}

%% macros used for cross-referencing
 
%% \mmt@target{id}{text} defines text as the target of \mmt@ref{id}{...}
\newcommand{\mmt@target}[2]{\hyperdef{mmt}{#1}{#2}}
%% \mmt@ref{id}{text} makes text a reference to id
\newcommand{\mmt@ref}[2]{\hyperref{}{mmt}{#1}{\color{black}#2}}

%% macros used for putting a pdf tooltip on something
\newbox\tempboxa
\setbox\tempboxa=\hbox{} 
\immediate\pdfxform\tempboxa 
\edef\emptyicon{\the\pdflastxform}

\newcommand{\mmt@tooltip}[2]{%
  \pdfstartlink user{%
    /Subtype /Text
    /Contents  (#2)
    /AP <<
      /N \emptyicon\space 0 R
    >>
  }%
  {#1}%
  \pdfendlink%
}

%% macros used in the code generated by MMTTeX
\newcommand{\mmt@symref}[2]{\mmt@ref{#1}{#2}}
\newcommand{\mmt@varref}[2]{#2}
\newcommand{\mmt@lit}[1]{#1}
\newcommand{\mmt@group}[1]{#1}
\newcommand{\mmt@implicit}[1]{#1}
\newcommand{\mmt@inferred}[1]{#1}

%% utilities

% \mmt@ifnonempty[b]{test}{a} = if (test == empty) a else b
\newcommand{\mmt@ifnonempty}[3][]{\def\@empty{}\def\@test{#2}\ifx\@test\@empty#1\else#3\fi}
